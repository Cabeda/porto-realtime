datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

// --- Analytics models only (subset needed by the worker) ---

model BusPositionLog {
  id          BigInt   @id @default(autoincrement())
  recordedAt  DateTime @default(now())
  vehicleId   String
  vehicleNum  String?
  route       String?
  tripId      String?
  directionId Int?     @db.SmallInt
  lat         Float
  lon         Float
  speed       Float?   @db.Real
  heading     Float?   @db.Real

  @@index([recordedAt])
  @@index([route, recordedAt])
  @@index([vehicleId, recordedAt])
}

model RouteSegment {
  id           String  @id
  route        String
  directionId  Int     @db.SmallInt
  segmentIndex Int
  startLat     Float
  startLon     Float
  endLat       Float
  endLon       Float
  midLat       Float
  midLon       Float
  lengthM      Float   @db.Real
  geometry     Json

  @@index([route, directionId])
}

model TripLog {
  id                   BigInt   @id @default(autoincrement())
  date                 DateTime @db.Date
  vehicleId            String
  vehicleNum           String?
  route                String
  tripId               String?
  directionId          Int?     @db.SmallInt
  startedAt            DateTime?
  endedAt              DateTime?
  runtimeSecs          Int?
  scheduledRuntimeSecs Int?
  positions            Int
  avgSpeed             Float?   @db.Real
  commercialSpeed      Float?   @db.Real

  @@index([date, route])
  @@index([vehicleId, date])
}

model SegmentSpeedHourly {
  id          BigInt   @id @default(autoincrement())
  segmentId   String
  route       String
  directionId Int?     @db.SmallInt
  hourStart   DateTime
  avgSpeed    Float?   @db.Real
  medianSpeed Float?   @db.Real
  p10Speed    Float?   @db.Real
  p90Speed    Float?   @db.Real
  sampleCount Int

  @@unique([segmentId, hourStart])
  @@index([route, hourStart])
  @@index([hourStart])
}

model RoutePerformanceDaily {
  id                    BigInt   @id @default(autoincrement())
  date                  DateTime @db.Date
  route                 String
  directionId           Int?     @db.SmallInt
  tripsObserved         Int
  tripsScheduled        Int?
  avgHeadwaySecs        Float?   @db.Real
  scheduledHeadwaySecs  Float?   @db.Real
  headwayAdherencePct   Float?   @db.Real
  excessWaitTimeSecs    Float?   @db.Real
  avgRuntimeSecs        Float?   @db.Real
  avgCommercialSpeed    Float?   @db.Real
  bunchingPct           Float?   @db.Real
  gappingPct            Float?   @db.Real

  @@unique([date, route, directionId])
  @@index([date])
  @@index([route])
}

model RouteStop {
  id           String  @id
  route        String
  directionId  Int     @db.SmallInt
  stopSequence Int
  stopId       String
  stopName     String?
  lat          Float
  lon          Float

  @@index([route, directionId])
}

model StopHeadwayDaily {
  id             BigInt   @id @default(autoincrement())
  date           DateTime @db.Date
  route          String
  directionId    Int?     @db.SmallInt
  stopId         String
  stopName       String?
  stopSequence   Int
  avgHeadwaySecs Float?   @db.Real
  headwayStdDev  Float?   @db.Real
  observations   Int

  @@unique([date, route, directionId, stopId])
  @@index([date, route])
}

model NetworkSummaryDaily {
  id                  BigInt   @id @default(autoincrement())
  date                DateTime @db.Date @unique
  activeVehicles      Int
  totalTrips          Int
  avgCommercialSpeed  Float?   @db.Real
  avgExcessWaitTime   Float?   @db.Real
  worstRoute          String?
  worstRouteEwt       Float?   @db.Real
  positionsCollected  BigInt

  @@index([date])
}
