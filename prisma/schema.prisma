datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

// User model — supports anonymous (anonId) and authenticated (email) users
model User {
  id            String     @id @default(cuid())
  anonId        String?    @unique // localStorage UUID for anonymous users
  email         String?    @unique // for magic-link auth
  emailVerified DateTime?  // null = not verified, timestamp = when verified
  name          String?
  role          UserRole   @default(USER)
  createdAt     DateTime   @default(now())
  feedbacks     Feedback[]
  sessions      Session[]
}

// Server-side sessions for authenticated users
model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

// Magic link tokens for passwordless email auth
model MagicLink {
  id        String    @id @default(cuid())
  email     String
  code      String // 6-digit OTP code
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email, code])
}

// Feedback on lines, stops, and vehicles (extensible to ROUTE_PROPOSAL, FEATURE_REQUEST)
model Feedback {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      FeedbackType
  targetId  String // line shortName (e.g. "205"), stop gtfsId (e.g. "2:BRRS2"), or vehicleNumber (e.g. "3245")
  rating    Int // 1-5 stars
  comment   String? // optional, max 500 chars
  metadata  Json? // optional context: e.g. { "lineContext": "205" } for vehicle feedback
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([userId, type, targetId]) // one rating per user per target (upsert)
  @@index([type, targetId])
  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
}

enum FeedbackType {
  BUS // deprecated alias kept for compat — maps to LINE
  LINE
  STOP
  VEHICLE // feedback on a specific physical bus (by vehicleNumber)
  BIKE_PARK // bike parking stations
  BIKE_LANE // bike lanes (ciclovias)
}
