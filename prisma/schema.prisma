datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

// User model — authenticated users via Neon Auth
model User {
  id              String           @id @default(cuid())
  email           String?          @unique // email from Neon Auth
  emailVerified   DateTime?        // null = not verified, timestamp = when verified
  name            String?
  role            UserRole         @default(USER)
  createdAt       DateTime         @default(now())
  feedbacks       Feedback[]
  feedbackVotes   FeedbackVote[]
  reports         Report[]
  checkIns        CheckIn[]
  proposals       Proposal[]
  proposalVotes   ProposalVote[]
  proposalReports ProposalReport[]
}

// Feedback on lines, stops, and vehicles (extensible to ROUTE_PROPOSAL, FEATURE_REQUEST)
model Feedback {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      FeedbackType
  targetId  String // line shortName (e.g. "205"), stop gtfsId (e.g. "2:BRRS2"), or vehicleNumber (e.g. "3245")
  rating    Int // 1-5 stars
  comment   String? // optional, max 500 chars
  metadata  Json? // optional context: e.g. { "lineContext": "205" } for vehicle feedback
  tags      String[] @default([]) // issue tags: OVERCROWDED, LATE, DIRTY, etc.
  hidden    Boolean  @default(false) // auto-hidden after N reports
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  votes     FeedbackVote[]
  reports   Report[]

  @@unique([userId, type, targetId]) // one rating per user per target (upsert)
  @@index([type, targetId])
  @@index([userId])
}

// Upvote on a feedback review — one per user per review
model FeedbackVote {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedbackId String
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, feedbackId])
  @@index([feedbackId])
}

// Report on a feedback review — one per user per review
model Report {
  id         String       @id @default(cuid())
  feedbackId String
  feedback   Feedback     @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason     ReportReason
  createdAt  DateTime     @default(now())

  @@unique([feedbackId, userId]) // one report per user per feedback
  @@index([feedbackId])
}

// Transit check-in — users check in to a transit mode
// userId is optional to support anonymous check-ins (GDPR-friendly)
// lat/lon represent the target infrastructure location (bus stop, bike park), NOT user GPS
model CheckIn {
  id        String      @id @default(cuid())
  userId    String?
  user      User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  mode      TransitMode
  targetId  String?     // optional: line shortName ("205"), metro line ("D")
  lat       Float?      // infrastructure coords (bus stop, bike park); null for user-location check-ins
  lon       Float?
  anonHash  String?     // truncated hash of IP+UA for anonymous rate limiting (not PII)
  createdAt DateTime    @default(now())
  expiresAt DateTime    // createdAt + duration (30min anon, 1h auth)

  @@index([expiresAt])
  @@index([userId])
  @@index([anonHash, createdAt]) // for anonymous rate limiting queries
  @@index([expiresAt, mode, targetId]) // for active check-in aggregation queries
}

enum UserRole {
  USER
  ADMIN
}

enum FeedbackType {
  BUS // deprecated alias kept for compat — maps to LINE
  LINE
  STOP
  VEHICLE // feedback on a specific physical bus (by vehicleNumber)
  BIKE_PARK // bike parking stations
  BIKE_LANE // bike lanes (ciclovias)
}

enum ReportReason {
  SPAM
  OFFENSIVE
  MISLEADING
  OTHER
}

enum TransitMode {
  BUS
  METRO
  BIKE
  WALK
  SCOOTER
}

// --- Proposals: community suggestions for transit improvements ---

enum ProposalType {
  BIKE_LANE    // improve existing or propose new bike lanes
  STOP         // stop improvements (shelter, accessibility, signage)
  LINE         // improve existing or propose new transit lines
}

enum ProposalStatus {
  OPEN
  UNDER_REVIEW // enough votes to be considered
  CLOSED
  ARCHIVED
}

// Community proposal for transit improvements
model Proposal {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        ProposalType
  title       String           // concise summary, max 120 chars
  description String           // detailed justification, max 2000 chars
  targetId    String?          // optional: line shortName, stop gtfsId, bike lane id
  linkUrl     String?          // optional reference URL for more details
  geometry    Json?            // optional GeoJSON geometry (LineString/MultiLineString/Point)
  status      ProposalStatus   @default(OPEN)
  hidden      Boolean          @default(false) // auto-hidden after N reports
  votes       ProposalVote[]
  reports     ProposalReport[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([status])
  @@index([type])
  @@index([userId])
  @@index([type, targetId])
}

// Upvote on a proposal — one per user per proposal
model ProposalVote {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, proposalId])
  @@index([proposalId])
}

// Report on a proposal — one per user per proposal
model ProposalReport {
  id         String       @id @default(cuid())
  proposalId String
  proposal   Proposal     @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason     ReportReason
  createdAt  DateTime     @default(now())

  @@unique([proposalId, userId]) // one report per user per proposal
  @@index([proposalId])
}

// --- Analytics: bus position collection ---

// Raw GPS snapshots from FIWARE, collected every 30s by the Fly.io worker.
// Retained for 1 day in Postgres; permanently archived as Parquet on Hetzner.
model BusPositionLog {
  id          BigInt   @id @default(autoincrement())
  recordedAt  DateTime @default(now())
  vehicleId   String   // FIWARE entity id (e.g. "urn:ngsi-ld:Vehicle:porto:stcp:205:3245")
  vehicleNum  String?  // clean vehicle number (e.g. "3245")
  route       String?  // routeShortName (e.g. "205")
  tripId      String?  // STCP trip number from annotations
  directionId Int?     @db.SmallInt
  lat         Float
  lon         Float
  speed       Float?   @db.Real  // km/h from FIWARE
  heading     Float?   @db.Real  // degrees, 0-360

  @@index([recordedAt])
  @@index([route, recordedAt])
  @@index([vehicleId, recordedAt])
}

// --- Analytics: route segments (#66) ---

// Route segments (~200m each) derived from OTP pattern geometries.
// Used to map GPS positions to road segments for speed analysis.
model RouteSegment {
  id           String  @id  // "route:direction:index" e.g. "205:0:14"
  route        String
  directionId  Int     @db.SmallInt
  segmentIndex Int
  startLat     Float
  startLon     Float
  endLat       Float
  endLon       Float
  midLat       Float   // midpoint for fast GPS snapping
  midLon       Float
  lengthM      Float   @db.Real
  geometry     Json    // GeoJSON LineString

  @@index([route, directionId])
}

// --- Analytics: aggregated tables (#67) ---

// Reconstructed trips from GPS breadcrumbs
model TripLog {
  id                   BigInt   @id @default(autoincrement())
  date                 DateTime @db.Date
  vehicleId            String
  vehicleNum           String?
  route                String
  tripId               String?
  directionId          Int?     @db.SmallInt
  startedAt            DateTime?
  endedAt              DateTime?
  runtimeSecs          Int?
  scheduledRuntimeSecs Int?
  positions            Int      // number of GPS points in this trip
  avgSpeed             Float?   @db.Real
  commercialSpeed      Float?   @db.Real  // route distance / total time

  @@index([date, route])
  @@index([vehicleId, date])
}

// Hourly speed statistics per route segment
model SegmentSpeedHourly {
  id          BigInt   @id @default(autoincrement())
  segmentId   String   // references RouteSegment.id
  route       String
  directionId Int?     @db.SmallInt
  hourStart   DateTime
  avgSpeed    Float?   @db.Real
  medianSpeed Float?   @db.Real
  p10Speed    Float?   @db.Real  // 10th percentile (worst)
  p90Speed    Float?   @db.Real  // 90th percentile (best)
  sampleCount Int

  @@unique([segmentId, hourStart])
  @@index([route, hourStart])
  @@index([hourStart])
}

// Daily route performance summary
model RoutePerformanceDaily {
  id                    BigInt   @id @default(autoincrement())
  date                  DateTime @db.Date
  route                 String
  directionId           Int?     @db.SmallInt
  tripsObserved         Int
  tripsScheduled        Int?
  avgHeadwaySecs        Float?   @db.Real
  scheduledHeadwaySecs  Float?   @db.Real
  headwayAdherencePct   Float?   @db.Real
  excessWaitTimeSecs    Float?   @db.Real
  avgRuntimeSecs        Float?   @db.Real
  avgCommercialSpeed    Float?   @db.Real
  bunchingPct           Float?   @db.Real
  gappingPct            Float?   @db.Real

  @@unique([date, route, directionId])
  @@index([date])
  @@index([route])
}

// Network-wide daily summary
model NetworkSummaryDaily {
  id                  BigInt   @id @default(autoincrement())
  date                DateTime @db.Date @unique
  activeVehicles      Int
  totalTrips          Int
  avgCommercialSpeed  Float?   @db.Real
  avgExcessWaitTime   Float?   @db.Real
  worstRoute          String?
  worstRouteEwt       Float?   @db.Real
  positionsCollected  BigInt

  @@index([date])
}
